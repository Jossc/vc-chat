<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
    <title>VC-Chat</title>
    <!--bootstrap-->
    <link rel="stylesheet" href="/webjars/adminlte/2.3.6/bootstrap/css/bootstrap.css">
    <!--font-awesome-->
    <link rel="stylesheet" href="/webjars/font-awesome/4.6.3/css/font-awesome.css">
    <!--AdminLTE-->
    <link rel="stylesheet" href="/webjars/adminlte/2.3.6/dist/css/AdminLTE.min.css">
    <link rel="stylesheet" href="/webjars/adminlte/2.3.6/dist/css/skins/_all-skins.css">
    <link rel="stylesheet/less" href="/webjars/adminlte/2.3.6/build/less/header.less">
    <link rel="stylesheet/less" href="/webjars/adminlte/2.3.6/build/less/dropdown.less">
    <link rel="stylesheet/less" href="/webjars/adminlte/2.3.6/build/less/sidebar.less">

    <!--进度条-->
    <link rel="stylesheet" href="/webjars/adminlte/2.3.6/plugins/pace/pace.min.css">
</head>
<body class="hold-transition skin-blue sidebar-mini" ng-app="app">
<!--wrapper-->
<div class="wrapper">
    <!--main-header-->
    <header class="main-header">
        <!-- Logo -->
        <a href="index.html" class="logo">
            <!-- mini logo for sidebar mini 50x50 pixels -->
            <span class="logo-mini"><b>VC</b></span>
            <!-- logo for regular state and mobile devices -->
            <span class="logo-lg"><b>VC</b>Chat</span>
        </a>
        <!-- Header Navbar: style can be found in header.less -->
        <nav class="navbar navbar-static-top">
            <!-- Sidebar toggle button-->
            <a href="javascript:void(0)" class="sidebar-toggle" data-toggle="offcanvas" role="button">
                <span class="sr-only">主要</span>
            </a>

            <div class="navbar-custom-menu">
                <ul class="nav navbar-nav">
                    <!-- User Account: style can be found in dropdown.less -->
                    <li class="dropdown user user-menu">
                        <a href="javascript:void(0)" class="dropdown-toggle" data-toggle="dropdown">
                            <img ng-src="{{loginUser.userAuthentication.details==null?'/webjars/adminlte/2.3.6/dist/img/user2-160x160.jpg':loginUser.userAuthentication.details.avatar}}"
                                 class="user-image"
                                 alt="User Image">
                            <span class="hidden-xs">{{loginUser.principal==null?"Anonymous":loginUser.principal}}</span>
                        </a>
                        <ul class="dropdown-menu">
                            <!-- User image -->
                            <li class="user-header">
                                <img ng-src="{{loginUser.userAuthentication.details==null?'/webjars/adminlte/2.3.6/dist/img/user2-160x160.jpg':loginUser.userAuthentication.details.avatar}}"
                                     class="img-circle"
                                     alt="User Image">
                                <p>
                                    {{loginUser.principal}}
                                    <small>POSITION</small>
                                </p>
                            </li>
                            <!-- Menu Body -->
                            <li class="user-body">
                                <div class="row">
                                    <div class="col-xs-4 text-center">
                                        <a href="#">功能1</a>
                                    </div>
                                    <div class="col-xs-4 text-center">
                                        <a href="#">功能2</a>
                                    </div>
                                    <div class="col-xs-4 text-center">
                                        <a href="#">功能3</a>
                                    </div>
                                </div>
                            </li>
                            <!-- Menu Footer-->
                            <li class="user-footer">
                                <div class="pull-left">
                                    <a href="#/admin/design/user_profile.html/5992fa65e4c30962c37a8e712bfa96027_d"
                                       target="_blank"
                                       class="btn btn-default btn-flat">个人详情</a>
                                </div>
                                <div class="pull-right">
                                    <a href="javascript:void(0)" ng-click="logout()"
                                       class="btn btn-default btn-flat">注销</a>
                                </div>
                            </li>
                        </ul>
                    </li>
                    <!-- Control Sidebar Toggle Button -->
                    <li>
                        <a href="#" data-toggle="control-sidebar"><i class="fa fa-gears"></i></a>
                    </li>
                </ul>
            </div>
        </nav>
    </header>
    <!--.main-header-->

    <!--main-sidebar-->
    <aside class="main-sidebar">
        <!-- sidebar: style can be found in sidebar.less -->
        <section class="sidebar">
            <!-- Sidebar user panel -->
            <div class="user-panel">
                <div class="pull-left image">
                    <img ng-src="{{loginUser.userAuthentication.details==null?'/webjars/adminlte/2.3.6/dist/img/user2-160x160.jpg':loginUser.userAuthentication.details.image}}"
                         class="img-circle" alt="User Image">
                </div>
                <div class="pull-left info">
                    <p>{{loginUser.principal==null?"Anonymous":loginUser.principal}}</p>
                    <i class="fa fa-user text-success"></i> POSITION
                </div>
            </div>
            <!-- search form -->
            <form action="#" method="get" class="sidebar-form">
                <div class="input-group">
                    <input type="text" name="q" class="form-control" placeholder="Search...">
                    <span class="input-group-btn">
                <button type="submit" name="search" id="search-btn" class="btn btn-flat"><i class="fa fa-search"></i>
                </button>
              </span>
                </div>
            </form>
            <!-- sidebar menu: : style can be found in sidebar.less -->
            <ul class="sidebar-menu">
                <li class="header">MAIN NAVIGATION</li>
                <li class="treeview">
                    <a href="javascript:void(0)">
                        <i class="fa"></i><span>聊天</span>
                        <span class="pull-right-container"><i class="fa fa-angle-left pull-right"></i></span>
                    </a>
                    <ul class="treeview-menu">
                        <li><a href="/#/chat.html"><i class="fa fa-circle-o"></i>聊天窗口</a></li>
                    </ul>
                </li>
            </ul>
        </section>
        <!-- /.sidebar -->
    </aside>
    <!--.main-sidebar-->

    <!-- content-wrapper -->
    <div class="content-wrapper">
        <div ng-view="" id="mainFrame" style="margin: 0 auto; width: 100%; height: 100%;"></div>
    </div>

    <!--main-footer-->
    <footer class="main-footer">
        <div class="pull-right hidden-xs">
            <b>Version</b> 0.0.1 Test
        </div>
        <strong>Copyright</strong> All rights reserved.
    </footer>
    <!--.main-footer-->

    <!-- control-sidebar -->
    <aside class="control-sidebar control-sidebar-dark">
        <!-- Create the tabs -->
        <ul class="nav nav-tabs nav-justified control-sidebar-tabs">
            <li><a href="#control-sidebar-home-tab" data-toggle="tab"><i class="fa fa-home"></i></a></li>
            <li><a href="#control-sidebar-settings-tab" data-toggle="tab"><i class="fa fa-gears"></i></a></li>
        </ul>
        <!-- Tab panes -->
        <div class="tab-content">
            <!-- Home tab content -->
            <div class="tab-pane" id="control-sidebar-home-tab">
                <h3 class="control-sidebar-heading">MAIN PAGE</h3>
                <ul class="control-sidebar-menu">
                    <li>
                        <a href="javascript:void(0)">
                            <i class="menu-icon fa fa-align-center bg-red"></i>

                            <div class="menu-info">
                                <h4 class="control-sidebar-subheading">Test</h4>
                                <p>T</p>
                            </div>
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </aside>
    <div class="control-sidebar-bg"></div>
    <!-- .control-sidebar -->
</div>
<!--.wrapper-->


</body>
<!--angularjs-->
<script src="/webjars/angularjs/1.4.8/angular.js"></script>
<script src="/webjars/angularjs/1.4.8/angular-route.js"></script>


<!--bootstrap-->
<script src="/webjars/adminlte/2.3.6/plugins/jQuery/jquery-2.2.3.min.js"></script>
<script src="/webjars/adminlte/2.3.6/bootstrap/js/bootstrap.js"></script>
<!--AdminLTE-->
<script src="/webjars/adminlte/2.3.6/dist/js/app.js"></script>

<!--进度条-->
<script src="/webjars/adminlte/2.3.6/plugins/pace/pace.min.js"></script>
<script src="js/socket.io/socket.io.js"></script>
<script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=yimdHOSqjplgZvTbH5ho8rZj"></script>

<script>
    var app = angular.module("app", ['ngRoute']);
    var socket;
    app.config(['$routeProvider', function ($routeProvider) {
        $routeProvider
            .when('/chat.html', {
                controller: "ChatController",
                templateUrl: '/chat.html'
            })
            .otherwise('/chat.html', {
                controller: "ChatController",
                templateUrl: '/chat.html'
            })
    }]);

    //增加路由跳转时的判断，如果是同一个页面重新刷新，则让其跳转到相应的页面。
    app.run(['$rootScope', '$window', '$location', '$log', '$http', function ($rootScope, $window, $location, $log, $http) {

        $rootScope.$on('$locationChangeStart', function (event, next, current) {
            var host = location.protocol + '//' + location.host;
            $http.get('/me')
                .success(function (response, state) {
                    $rootScope.loginUser = response;

                    if (socket) {
                        return;
                    }
                    socket = io.connect('http://localhost:1337/?accessToken=' + response.details.tokenValue);
                    socket.on('connect', function () {
                        console.log("连接成功")
                    });

                    socket.on("message", function (message) {
                        console.log(message);
                        $http.get("/chat/findNicknameAndAvatarAndIdById/" + message.data.toUserId)
                            .success(function (user) {
                                console.log(user);
                                var username = $rootScope.loginUser.userAuthentication.details.username;
                                var avatar = $rootScope.loginUser.userAuthentication.details.avatar;

                                var createdTime = message.data.priMessage.createdTime;
                                var priMessage = message.data.priMessage;
                                var lastMessage = message.data.lastMessage;
                                if (($rootScope.loginUser.userAuthentication.details.id) + '' !== priMessage.sendId) {
                                    username = user.username;
                                    avatar = user.avatar;
                                }
                                if (($rootScope.loginUser.userAuthentication.details.id) + '' !== priMessage.sendId) {
                                    notify(username, avatar, lastMessage);
                                }
                                if (priMessage.messageType === 1) {
                                    outputImg(username, avatar, createdTime, lastMessage);
                                } else if (priMessage.messageType === 2) {
                                    outputVideo(username, avatar, createdTime, lastMessage);
                                } else if (priMessage.messageType === 8) {
                                    outputAudio(username, avatar, createdTime, lastMessage);
                                } else if (priMessage.messageType === 3) {
                                    outGraphicText(username, avatar, createdTime, lastMessage);
                                } else if (priMessage.messageType === 7) {
                                    outputFileMessage(username, avatar, createdTime, lastMessage);
                                } else if (priMessage.messageType === 9) {
                                    outputLocation(username, avatar, createdTime, lastMessage);
                                } else {
                                    outputMessage(username, avatar, createdTime, lastMessage);
                                }
                                document.getElementById('directChat').scrollTop = document.getElementById('directChat').scrollHeight;
                            })
                            .error(function (response) {
                                console.log(response);
                            })
                    });

                    socket.on("error", function (message) {
                        notify(response.userAuthentication.details.username, response.userAuthentication.details.avatar, dialogue.lastMessage);
                    });

                    socket.on('disconnect', function () {
                    });
                    $rootScope.getUserUnreadTotal(response.userAuthentication.details.id);
                })
                .error(function (response) {
                    console.log(response.message)
                });

            $rootScope.getUserUnreadTotal = function (userId) {
                $http.get("/chat/getUserUnreadTotal/" + userId)
                    .success(function (response) {
                        $rootScope.userUnreadTotal = response;
                    })
                    .error(function (response) {
                        $rootScope.userUnreadTotal = 0;
                    })
            };
        });

    }]);

    app.controller("ChatController", function ($scope, $rootScope, $http) {
        $scope.onlineUsers = function () {
            $http.get("/chat/onlineUsers")
                .success(function (response) {
                    $scope.onlineUsers = response;
                })
                .error(function (response) {
                    console.log(response);
                })
        };

        $scope.listDialogue = function () {
            $http.get("/chat/listUserDialogueByUserId")
                .success(function (response) {
                    $scope.userDialogueDTOs = response;
                    $scope.currentToUserId = $scope.userDialogueDTOs.length > 0 ? $scope.userDialogueDTOs[0].user.id : 0;
                })
                .error(function (response) {
                    console.log(response);
                });
        };

        $scope.createDialogue = function (toUserId) {
            var req = {
                "toUserId": toUserId + ""
            };
            $http.post("/chat/createDialogue", req)
                .success(function (response) {
                    console.log(response);
                    $scope.listDialogue();
                })
                .error(function (response) {
                    console.log(response);
                })
        };

        $scope.sendMessage = function (message, messageType) {
            var req = {
                "message": message,
                "recId": $scope.currentToUserId,
                "messageType": messageType
            };
            $http.post("/chat/sendMessage", req)
                .success(function (response) {
                    console.log(response);
                    $scope.message = "";
                })
                .error(function (response) {
                    console.log(response);
                })
        };

        $scope.changDialogue = function (toUserId, dialogueId) {
            $rootScope.currentToUserId = toUserId;
            $rootScope.currentToDialogueId = dialogueId;
            $scope.listPriMessage(toUserId, dialogueId);
        };

        $scope.readMessage = function (dialogueId) {
            $http.put("/chat/readMessage/" + dialogueId)
                .success(function (response) {
                    console.log(response);
                })
                .error(function (response) {
                    console.log(response);
                })
        };

        $scope.deleteDialogue = function (dialogueId) {
            $http.delete("/chat/deleteDialogue/" + dialogueId)
                .success(function (response) {
                    if (dialogueId === $rootScope.currentToDialogueId) {
                        $("#directChat").html("");
                        $("#chat").hide();
                    }
                    $scope.listDialogue();
                })
                .error(function (response) {
                    console.log(response)
                })
        };

        $scope.listPriMessage = function (toUserId, dialogueId) {
            $http.get("/chat/listPriMessageByDialogueId/" + dialogueId + "?toUserId=" + toUserId)
                .success(function (response) {
                    $("#directChat").html("");
                    for (var i = response.priMessages.length - 1; i >= 0; i--) {
                        var priMessage = response.priMessages[i];
                        var username = response.user.username;
                        var avatar = response.user.avatar;
                        var createdTime = priMessage.createdTime;
                        var lastMessage = priMessage.message;

                        if (($rootScope.loginUser.userAuthentication.details.id) + '' !== priMessage.sendId) {
                            username = response.toUser.username;
                            avatar = response.toUser.avatar;
                        }

                        if (priMessage.messageType === 1) {
                            outputImg(username, avatar, createdTime, lastMessage);
                        } else if (priMessage.messageType === 2) {
                            outputVideo(username, avatar, createdTime, lastMessage);
                        } else if (priMessage.messageType === 8) {
                            outputVideo(username, avatar, createdTime, lastMessage);
                        } else if (priMessage.messageType === 3) {
                            outGraphicText(username, avatar, createdTime, lastMessage);
                        } else if (priMessage.messageType === 0) {
                            outputMessage(username, avatar, createdTime, lastMessage);
                        } else if (priMessage.messageType === 7) {
                            outputFileMessage(username, avatar, createdTime, lastMessage);
                        } else if (priMessage.messageType === 9) {
                            outputLocation(username, avatar, createdTime, lastMessage);
                        } else {
                            outputMessage(username, avatar, createdTime, lastMessage);
                        }
                    }
                    $scope.priMessageDTO = response;
                    $scope.readMessage(dialogueId);
                    $("#chat").show();
                })
                .error(function (response) {
                    console.log(response);
                })
        };


        $scope.upload = function upload(messageType) {
            var file;
            if (messageType === 1) {
                file = document.getElementById("file").files[0];
            }
            if (messageType === 2) {
                file = document.getElementById("file2").files[0];
            }

            if (messageType === 7) {
                file = document.getElementById("file7").files[0];
            }
            // FormData 对象
            var form = new FormData();
            form.append("toUserId", $rootScope.currentToUserId);//可以增加表单数据
            form.append("dialogueId", $rootScope.currentToDialogueId);// 文件对象
            form.append("file", file);// 文件对象
            form.append("messageType", messageType);// 文件对象
            // XMLHttpRequest 对象
            var xhr = new XMLHttpRequest();
            xhr.open("post", "/chat/upload", true);
            xhr.onload = function (event) {
                console.log(event);
            };
            xhr.send(form);
        };

        $scope.uploadImageModal = function () {
            $('#uploadImgDiv').modal('toggle')
        };

        $scope.uploadVideoModal = function () {
            $('#uploadVideoDiv').modal('toggle')
        };

        $scope.sendGraphicTextModal = function () {
            $('#sendGraphicTextDiv').modal('toggle')
        };

        $scope.uploadFileDivModal = function () {
            $('#uploadFileDiv').modal('toggle')
        };

        $scope.recordVideoDivModal = function () {
            $('#recordVideoDiv').modal('toggle')
        };

        $scope.recordAudioDivModal = function () {
            $('#recordAudioDiv').modal('toggle')
        };

        var searchLocation;
        var currentLocation;
        $scope.sendLocationDivModal = function () {
            $("#allmap").html("");
            // 百度地图API功能
            var map = new BMap.Map("allmap");
            var point = new BMap.Point(116.331398, 39.897445);
            map.centerAndZoom(point, 12);

            var geolocation = new BMap.Geolocation();
            geolocation.getCurrentPosition(function (r) {
                if (this.getStatus() == BMAP_STATUS_SUCCESS) {
                    var mk = new BMap.Marker(r.point);
                    map.addOverlay(mk);
                    map.panTo(r.point);
                }
                else {
                    alert('failed' + this.getStatus());
                }
            }, {enableHighAccuracy: true})
            map.enableScrollWheelZoom(true);
            $('#locationDivModal').modal({backdrop: 'static', keyboard: false})

            // 百度地图API功能
            function G(id) {
                return document.getElementById(id);
            }

            map.centerAndZoom("北京", 12);                   // 初始化地图,设置城市和地图级别。

            var ac = new BMap.Autocomplete(    //建立一个自动完成的对象
                {
                    "input": "suggestId"
                    , "location": map
                });

            ac.addEventListener("onhighlight", function (e) {  //鼠标放在下拉列表上的事件
                console.log(e);
                var str = "";
                var _value = e.fromitem.value;
                var value = "";
                if (e.fromitem.index > -1) {
                    value = _value.province + _value.city + _value.district + _value.street + _value.business;
                }
                str = "FromItem<br />index = " + e.fromitem.index + "<br />value = " + value;

                value = "";
                if (e.toitem.index > -1) {
                    _value = e.toitem.value;
                    value = _value.province + _value.city + _value.district + _value.street + _value.business;
                }
                str += "<br />ToItem<br />index = " + e.toitem.index + "<br />value = " + value;
                G("searchResultPanel").innerHTML = str;
                setTimeout(function () {
                    $(".tangram-suggestion-main").css({"z-index": 6666})
                },1000);

            });

            ac.addEventListener("onconfirm", function (e) {    //鼠标点击下拉列表后的事件
                console.log(e);
                var _value = e.item.value;
                searchLocation = _value.province + _value.city + _value.district + _value.street + _value.business;
                G("searchResultPanel").innerHTML = "onconfirm<br />index = " + e.item.index + "<br />searchLocation = " + searchLocation;
                setPlace();

            });



            function setPlace() {
                map.clearOverlays();    //清除地图上所有覆盖物
                var local = new BMap.LocalSearch(map, { //智能搜索
                    onSearchComplete: function () {
                        var pp = local.getResults().getPoi(0).point;    //获取第一个智能搜索的结果
                        currentLocation = pp;
                        map.centerAndZoom(pp, 18);
                        map.addOverlay(new BMap.Marker(pp));    //添加标注
                    }
                });
                local.search(searchLocation);
            }

        };

        $scope.sendLocation = function () {
            navigator.geolocation.getCurrentPosition(function (r) {
                var latitude = r.coords.latitude;
                var longitude = r.coords.longitude;
                if (currentLocation) {
                    latitude = currentLocation.lat;
                    longitude = currentLocation.lng;
                    var message = {latitude: latitude, longitude: longitude, address: searchLocation};
                    $scope.sendMessage(JSON.stringify(message), 9);
                } else {
                    // 百度地图API功能
                    var point = new BMap.Point(longitude, latitude);
                    var geoc = new BMap.Geocoder();
                    geoc.getLocation(point, function (rs) {
                        //addressComponents对象可以获取到详细的地址信息
                        var addComp = rs.addressComponents;
                        //将对应的HTML元素设置值
                        console.log(addComp);
                        var message = {latitude: latitude, longitude: longitude, address: addComp};
                        $scope.sendMessage(JSON.stringify(message), 9);

                    });
                }
            });
        };

        $scope.takeSnapshotDivModal = function () {
            stopStream();
            takeSnapshots = [];
            $("#takeSnapshotPhotos").html("");
            navigator.mediaDevices
                .getUserMedia({
                    audio: false,
                    video: true
                })
                .then(function handleSuccess(stream) {
                    window.stream = stream; // make stream available to browser console
                    localStream = stream;
                    var takeVideo = document.getElementById("takeVideo");
                    takeVideo.srcObject = stream;
                })
                .catch(function handleError(error) {
                    console.log('navigator.getUserMedia error: ', error);
                });
            $('#takeSnapshotDiv').modal('toggle')
        };

        $scope.sendGraphicText = function (graphicText) {
            $scope.sendMessage(JSON.stringify(graphicText), 3);
        };

        $scope.startRecordVideo = function () {
            stopStream();
            var servers = {iceServers: []};
            recordedBlobs = [];
            navigator.getUserMedia({
                audio: true,
                video: {mandatory: {maxWidth: 600, maxHeight: 233}}
            }, function (stream) {
                localStream = stream;
                var videoRecord = document.getElementById("recordVideo");
                videoRecord.src = window.URL.createObjectURL(stream);
                var options = {mimeType: 'video/webm'};
                mediaRecorder = new MediaRecorder(stream, options);
                mediaRecorder.ondataavailable = handleDataAvailable;
                mediaRecorder.start(100); // collect 100ms of data
            }, function (error) {
                console.log(error);
            });
        };

        $scope.sendRecordVideo = function () {
            var blob = new Blob(recordedBlobs, {type: 'video/webm'});
            var form = new FormData();
            form.append("file", blob, "file.webm");
            form.append("toUserId", $scope.currentToUserId);
            form.append("dialogueId", $scope.currentToDialogueId);
            form.append("messageType", 2);
            var request = new XMLHttpRequest();
            request.open("POST", "/chat/upload");
            request.send(form);
        };

        $scope.startRecordAudio = function () {
            stopStream();
            navigator.getUserMedia({
                audio: true
            }, function (stream) {
                localStream = stream;
                var recordAudio = document.getElementById("recordAudio");
                recordAudio.src = window.URL.createObjectURL(stream);
                mediaRecorder = new MediaRecorder(stream, {});
                mediaRecorder.ondataavailable = handleDataAvailable;
                mediaRecorder.start(100); // collect 100ms of data
            }, function (error) {
                console.log(error);
            });
        };

        $scope.sendRecordAudio = function () {
            var blob = new Blob(recordedBlobs, {type: 'video/wav'});
            var form = new FormData();
            form.append("file", blob);
            form.append("audio", blob, "audio.wav");
            form.append("toUserId", $scope.currentToUserId);
            form.append("dialogueId", $scope.currentToDialogueId);
            form.append("messageType", 8);
            var request = new XMLHttpRequest();
            request.open("POST", "/chat/upload");
            request.send(form);
        };

        $scope.sendTakeSnapshots = function () {
            takeSnapshots.forEach(function (blob) {
                var form = new FormData();
                form.append("file", blob);
                form.append("image", blob, "image.png");
                form.append("toUserId", $scope.currentToUserId);
                form.append("dialogueId", $scope.currentToDialogueId);
                form.append("messageType", 1);
                var request = new XMLHttpRequest();
                request.open("POST", "/chat/upload");
                request.send(form);
            });
        };

        $scope.onlineUsers();
        $scope.listDialogue();


    });


    //通知框，与websocket 无关 请忽略
    window.addEventListener("load", function () {
        if (Notification && Notification.permission !== "granted") {
            Notification.requestPermission(function (status) {
                if (Notification.permission !== status) {
                    Notification.permission = status;
                }
            });
        }
    });

    function notify(username, avatar, message) {
        if (Notification && Notification.permission === "granted") {
            //通知框，与websocket 无关 请忽略
            var options = {
                dir: "ltr",
                lang: "utf-8",
                icon: avatar,
                body: message
            };
            var n = new Notification(username + ":" + new Date().toDateString(), options);
            n.onshow = function () {
                console.log("You got me!");
            };
            n.onclick = function () {
                alert("You clicked me!");
                window.location = "/";
            };
            n.onclose = function () {
                console.log("notification closed!");
            };
            n.onerror = function () {
                console.log("An error accured");
            }
        } else {
            alert(message);
        }
    }

    var recordedBlobs = [];
    var mediaRecorder;

    function handleDataAvailable(event) {
        if (event.data && event.data.size > 0) {
            recordedBlobs.push(event.data);
        }
    }

    var localStream;

    function stopStream() {
        if (localStream) {
            localStream.getTracks().forEach(function (track) {
                track.stop();
            });
        }
    };

    function stopRecordAudio() {
        mediaRecorder.stop();
        var recordAudio = document.getElementById("recordAudio");
        recordAudio.pause();
        console.log('Recorded Blobs: ', recordedBlobs);
        stopStream()
    }

    function stopRecordVideo() {
        mediaRecorder.stop();
        var recordVideo = document.getElementById("recordVideo");
        recordVideo.pause();
        console.log('Recorded Blobs: ', recordedBlobs);
        stopStream()
    }

    function downloadVideoRecord() {
        var blob = new Blob(recordedBlobs, {type: 'video/webm'});
        var url = window.URL.createObjectURL(blob);
        var a = document.createElement('a');
        a.style.display = 'none';
        a.target = "_blank";
        a.href = url;
        a.download = new Date().getTime() + '.webm';
        document.body.appendChild(a);
        a.click();
        setTimeout(function () {
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }, 100);
    }

    function downloadAudioRecord() {
        var blob = new Blob(recordedBlobs, {type: 'video/wav'});
        var url = window.URL.createObjectURL(blob);
        var a = document.createElement('a');
        a.style.display = 'none';
        a.target = "_blank";
        a.href = url;
        a.download = new Date().getTime() + '.wav';
        document.body.appendChild(a);
        a.click();
        setTimeout(function () {
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }, 100);
    }

    var takeSnapshots = [];

    function takeSnapshot() {
        var canvas = document.createElement("canvas");
        var video = document.getElementById("takeVideo");
        canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
        canvas.toBlob(function (result) {
            var imgUrl = URL.createObjectURL(result);
            takeSnapshots.push(result);
            var body = $('                                <li>\n' +
                '                                    <span class="mailbox-attachment-icon has-img"><img src="' + imgUrl + '" alt="Attachment"></span>\n' +
                '\n' +
                '                                    <div class="mailbox-attachment-info">\n' +
                '                                        <a href="' + imgUrl + '" target="_blank" class="mailbox-attachment-name"><i class="fa fa-camera"></i>' + new Date().getTime() + '.png</a>\n' +
                '                                        <span class="mailbox-attachment-size">\n' +
                '                          ' + (result.size / 1024 / 1024).toFixed(2) + ' MB\n' +
                '                          <a href="' + imgUrl + '" target="_blank" class="btn btn-default btn-xs pull-right"><i class="fa fa-cloud-download"></i></a>\n' +
                '                        </span>\n' +
                '                                    </div>\n' +
                '                                </li>');
            $("#takeSnapshotPhotos").append(body);
            document.getElementById('takeSnapshotPhotosDiv').scrollTop = document.getElementById('takeSnapshotPhotosDiv').scrollHeight;
        });
    }


    function outputMessage(username, avatar, createdTime, message) {
        var body = $(' <div class="box-footer box-comments">\n' +
            '                            <div class="box-comment">\n' +
            '                                <img class="img-circle img-sm" src="' + avatar + '"\n' + 'alt="User Image">\n' +
            '                                <div class="comment-text">\n' +
            '                                  <span class="username">\n' +
            '                                   ' + username + '' +
            '                                    <span class="text-muted pull-right">' + new Date(createdTime).toDateString() + '</span></span>\n' +
            '                                    ' + message + '\n' +
            '                                </div>\n' +
            '                            </div>\n' +
            '                        </div>');

        $("#directChat").append(body)
    }

    function outputFileMessage(username, avatar, createdTime, message) {
        var host = location.protocol + '//' + location.host;
        var fileDescription = JSON.parse(message);
        // var body = $(' <div class="box-footer box-comments">\n' +
        //     '                            <div class="box-comment">\n' +
        //     '                                <img class="img-circle img-sm" src="' + avatar + '"\n' + 'alt="User Image">\n' +
        //     '                                <div class="comment-text">\n' +
        //     '                                  <span class="username">\n' +
        //     '                                   ' + username + '' +
        //     '                                    <span class="text-muted pull-right">' + new Date(createdTime).toDateString() + '</span></span>\n' +
        //     '                                    <a href="' + message + '" target="_blank">' + host + fileDescription.url + '</a>\n' +
        //     '                                </div>\n' +
        //     '                            </div>\n' +
        //     '                        </div>');

        var body = $('<div class="box-body" >\n' +
            '                            <div class="box-comment">\n' +
            '                                <img class="img-circle img-sm" src="' + avatar + '"\n' +
            '                                     alt="User Image">\n' +
            '                                <div class="comment-text">\n' +
            '                              <span class="username">\n' +
            '                                 ' + username + '' +
            '                                <span class="text-muted pull-right">' + new Date(createdTime).toDateString() + '</span></span><!-- /.username -->\n' +
            '                                </div>\n' +
            '                            </div>\n' + '<div class="mailbox-attachment-info">\n' +
            '                    <a href="' + host + fileDescription.url + '" class="mailbox-attachment-name"><i class="fa fa-paperclip"></i> ' + fileDescription.name + '</a>\n' +
            '                        <span class="mailbox-attachment-size">\n' +
            '                          ' + (fileDescription.size / 1024 / 1024).toFixed(2) + ' MB\n' +
            '                          <a href="' + host + fileDescription.url + '" class="btn btn-default btn-xs pull-right"><i class="fa fa-cloud-download"></i></a>\n' +
            '                        </span>\n' +
            '                  </div>' +
            '                        </div>');

        $("#directChat").append(body)
    }

    function outputImg(username, avatar, createdTime, message) {
        var fileDescription = JSON.parse(message);
        var body = $('<div class="box-body" >\n' +
            '                            <div class="box-comment">\n' +
            '                                <img class="img-circle img-sm" src="' + avatar + '"\n' +
            '                                     alt="User Image">\n' +
            '                                <div class="comment-text">\n' +
            '                              <span class="username">\n' +
            '                                 ' + username + '' +
            '                                <span class="text-muted pull-right">' + new Date(createdTime).toDateString() + '</span></span><!-- /.username -->\n' +
            '                                </div>\n' +
            '                            </div>\n' +
            '                            <img class="img-responsive pad" src="' + fileDescription.url + '"\n' +
            '                                 alt="Photo">\n' +
            '                        </div>');
        $("#directChat").append(body)
    }

    function outputLocation(username, avatar, createdTime, message) {
        var json = JSON.parse(message);
        var id = "baidu" + new Date().getTime();
        var body = $('<div class="box-body" >\n' +
            '                            <div class="box-comment">\n' +
            '                                <img class="img-circle img-sm" src="' + avatar + '"\n' +
            '                                     alt="User Image">\n' +
            '                                <div class="comment-text">\n' +
            '                              <span class="username">\n' +
            '                                 ' + username + '' +
            '                                <span class="text-muted pull-right">' + new Date(createdTime).toDateString() + '</span></span><!-- /.username -->\n' +
            '                                </div>\n' +
            '                            </div>\n' +
            '                            <div  style="height: 300px" id="' + id + '"></div>\n' +
            '                        </div>');
        $("#directChat").append(body);
        // 百度地图API功能
        var map = new BMap.Map(id);
        var point = new BMap.Point(json.longitude, json.latitude);
        var mk = new BMap.Marker(point);
        map.addOverlay(mk);
        map.panTo(point);
        map.centerAndZoom(point, 12);
        map.enableScrollWheelZoom(true);
    }

    function outputVideo(username, avatar, createdTime, message) {
        var fileDescription = JSON.parse(message);
        var body = $('<div class="box-body" >\n' +
            '                            <div class="box-comment">\n' +
            '                                <img class="img-circle img-sm" src="' + avatar + '"\n' +
            '                                     alt="User Image">\n' +
            '                                <div class="comment-text">\n' +
            '                              <span class="username">\n' +
            '                                 ' + username + '' +
            '                                <span class="text-muted pull-right">' + new Date(createdTime).toDateString() + '</span></span><!-- /.username -->\n' +
            '                                </div>\n' +
            '                            </div>\n' +
            '                            <video class="img-responsive pad" controls="controls" autoplay src="' + fileDescription.url + '"\n' +
            '                                >\n' +
            '                        </div>');
        $("#directChat").append(body)
    }

    function outputAudio(username, avatar, createdTime, message) {
        var fileDescription = JSON.parse(message);
        var body = $('<div class="box-body" >\n' +
            '                            <div class="box-comment">\n' +
            '                                <img class="img-circle img-sm" src="' + avatar + '"\n' +
            '                                     alt="User Image">\n' +
            '                                <div class="comment-text">\n' +
            '                              <span class="username">\n' +
            '                                 ' + username + '' +
            '                                <span class="text-muted pull-right">' + new Date(createdTime).toDateString() + '</span></span><!-- /.username -->\n' +
            '                                </div>\n' +
            '                            </div>\n' +
            '                            <audio class="img-responsive pad" controls="controls" autoplay src="' + fileDescription.url + '"\n' +
            '                                >\n' +
            '                        </div>');
        $("#directChat").append(body)
    }

    function outGraphicText(username, avatar, createdTime, message) {
        var obj = JSON.parse(message);
        var body = $('<div class="attachment-block clearfix">\n' +
            '                                <img class="img-circle img-sm" src="' + avatar + '"\n' +
            '                                     alt="User Image">\n' +
            '                                <div class="comment-text">\n' +
            '                              <span class="username">\n' +
            '                                 ' + username + '' +
            '                                <span class="text-muted pull-right">' + new Date(createdTime).toDateString() + '</span></span><!-- /.username -->\n' +
            '                                </div>\n' +
            '                <img class="attachment-img" src="' + obj.img + '" alt="Attachment Image">\n' +
            '\n' +
            '                <div class="attachment-pushed">\n' +
            '                  <h4 class="attachment-heading"><a href="' + obj.url + '" target="_blank">' + obj.title + '</a></h4>\n' +
            '\n' +
            '                  <div class="attachment-text">\n' +
            '             ' + obj.text + ' <a href="' + obj.url + '" target="_blank">more</a>\n' +
            '                  </div>\n' +
            '                  <!-- /.attachment-text -->\n' +
            '                </div>\n' +
            '                <!-- /.attachment-pushed -->\n' +
            '              </div>');
        $("#directChat").append(body)

    }


</script>

</html>